<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Planos - YouTube Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-[#0f0f0f] text-white font-sans">
    <div class="max-w-6xl mx-auto px-4 py-20">
      <div class="text-center mb-16">
        <h1 class="text-4xl font-bold mb-4">Escolha o plano ideal</h1>
        <p class="text-gray-400">Desbloqueie todo o potencial do seu canal.</p>
      </div>

      <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
        <!-- Free -->
        <div
          class="p-8 bg-[#1e1e1e] rounded-2xl border border-gray-800 flex flex-col"
        >
          <h3 class="text-2xl font-bold mb-2">Gratuito</h3>
          <div class="text-4xl font-bold mb-6">
            R$ 0<span class="text-lg text-gray-500 font-normal">/mês</span>
          </div>
          <ul class="space-y-4 mb-8 flex-1 text-gray-300">
            <li>✅ 10 Créditos de envio</li>
            <li>✅ Acesso ao Feed de Vídeos</li>
            <li>❌ Automação Limitada</li>
          </ul>
          <a
            href="/login"
            class="block text-center py-3 border border-gray-600 rounded-lg hover:bg-gray-800"
            >Começar Grátis</a
          >
        </div>

        <!-- Pro -->
        <div
          class="p-8 bg-gradient-to-b from-red-900 to-[#1e1e1e] rounded-2xl border border-red-600 flex flex-col relative overflow-hidden"
        >
          <div
            class="absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-bl-lg"
          >
            POPULAR
          </div>
          <h3 class="text-2xl font-bold mb-2">PRO</h3>
          <div class="text-4xl font-bold mb-6">
            R$ {{ "%.2f"|format(price/100)|replace('.', ',') }}<span
              class="text-lg text-gray-300 font-normal"
              >/mês</span
            >
          </div>
          <ul class="space-y-4 mb-8 flex-1 text-white">
            <li>✅ Envios Ilimitados</li>
            <li>✅ Automação Completa (Loop)</li>
            <li>✅ Suporte Prioritário</li>
            <li>✅ Templates Personalizados</li>
          </ul>
          <a
            href="#"
            id="btnSubscribe"
            class="block text-center py-3 bg-white text-black font-bold rounded-lg hover:bg-gray-200 transition"
            >Assinar Agora</a
          >
        </div>
      </div>
    </div>

    <!-- MODAL PIX TRANSPARENTE -->
    <div
      id="pixModal"
      class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm"
    >
      <div
        class="bg-[#1e1e1e] border border-gray-700 p-6 rounded-2xl max-w-md w-full mx-4 text-center shadow-2xl"
      >
        <h3 class="text-2xl font-bold mb-4 text-white">Pagamento via PIX</h3>
        <p class="text-gray-400 text-sm mb-4">
          Escaneie o QR Code ou copie o código abaixo para liberar seu acesso
          instantaneamente.
        </p>

        <div class="bg-white p-2 rounded-lg inline-block mb-4">
          <img
            id="pixQr"
            src=""
            alt="QR Code PIX"
            class="w-48 h-48 object-contain mx-auto"
          />
        </div>

        <div class="relative mb-6">
          <input
            type="text"
            id="pixCode"
            readonly
            class="w-full bg-[#121212] border border-gray-700 text-gray-300 text-xs p-3 rounded pr-20 focus:outline-none focus:border-red-600"
          />
          <button
            onclick="copyPix()"
            class="absolute right-1 top-1 bottom-1 px-3 bg-gray-800 hover:bg-gray-700 text-white text-xs font-bold rounded transition"
          >
            COPIAR
          </button>
        </div>

        <div class="flex gap-3 justify-center">
          <button
            onclick="closePixModal()"
            class="px-6 py-2 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-800 transition"
          >
            Fechar
          </button>
          <a
            href="/app"
            class="px-6 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition flex items-center gap-2"
          >
            <span>Já Paguei</span>
          </a>
        </div>
      </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="/static/js/firebase-config.js"></script>

    <script>
      let pollInterval;
      document
        .getElementById("btnSubscribe")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          const user = auth.currentUser;

          if (!user) {
            // Salva a intenção de compra para redirecionar depois do login (opcional)
            window.location.href = "/login?redirect=plans";
          } else {
            const btn = document.getElementById("btnSubscribe");
            const originalText = btn.innerText;

            // Evita múltiplos cliques
            if (btn.getAttribute("data-loading") === "true") return;

            btn.setAttribute("data-loading", "true");
            btn.innerText = "Processando...";
            // Em tags <a>, disabled não funciona nativamente, usamos data-loading
            btn.classList.add("opacity-50", "cursor-not-allowed");

            try {
              const token = await user.getIdToken();
              const response = await fetch("/create_checkout", {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
              });

              // Verifica se a resposta é válida antes de tentar ler o JSON
              if (!response.ok) {
                const errText = await response.text();
                throw new Error(
                  `Erro no servidor (${response.status}): ${errText}`,
                );
              }

              const data = await response.json();
              console.log("Dados do Checkout:", data); // Verifique o console (F12) se der erro

              if (data.status === "success") {
                if (data.pix && data.pix.code) {
                  // Exibe Modal PIX Transparente
                  document
                    .getElementById("pixModal")
                    .classList.remove("hidden");
                  document.getElementById("pixCode").value = data.pix.code;
                  if (data.pix.qr_code)
                    document.getElementById("pixQr").src = data.pix.qr_code;

                  startPolling();
                } else if (data.url) {
                  console.warn(
                    "PIX não encontrado, redirecionando para URL:",
                    data.url,
                  );
                  // Se não tiver PIX (ex: cartão), redireciona. Se quiser forçar PIX, remova este else if.
                  window.location.href = data.url;
                }
              } else {
                throw new Error(
                  data.message || "Erro desconhecido ao criar checkout.",
                );
              }
            } catch (err) {
              console.error(err);
              // Tenta extrair mensagem de erro limpa se for JSON no erro
              let msg = err.message;
              if (msg.includes('"message":')) {
                try {
                  msg = JSON.parse(msg).message;
                } catch (e) {}
              }
              alert("Falha no pagamento: " + msg);
            } finally {
              // Sempre restaura o botão, independente de sucesso ou erro
              btn.innerText = originalText;
              btn.removeAttribute("data-loading");
              btn.classList.remove("opacity-50", "cursor-not-allowed");
            }
          }
        });

      function closePixModal() {
        document.getElementById("pixModal").classList.add("hidden");
        if (pollInterval) clearInterval(pollInterval);
      }

      function copyPix() {
        const copyText = document.getElementById("pixCode");
        copyText.select();
        navigator.clipboard
          .writeText(copyText.value)
          .then(() => alert("Código PIX copiado!"));
      }

      function startPolling() {
        if (pollInterval) clearInterval(pollInterval);
        pollInterval = setInterval(async () => {
          try {
            const user = auth.currentUser;
            if (!user) return;
            const token = await user.getIdToken();
            const res = await fetch("/api/check_status", {
              headers: { Authorization: `Bearer ${token}` },
            });
            const data = await res.json();
            if (data.status === "approved") {
              clearInterval(pollInterval);
              window.location.href = "/thank-you";
            }
          } catch (e) {
            console.error("Erro no polling:", e);
          }
        }, 3000);
      }
    </script>
  </body>
</html>
